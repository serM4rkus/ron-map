<div class="map-viewer">
  @if (currentMap) {
  <div class="map-canvas" #mapContainer (wheel)="onMouseWheel($event)">

    <!-- Loading Spinner -->
    @if (isLoading) {
    <div class="loading-overlay">
      <div class="spinner"></div>
      <p>Loading...</p>
    </div>
    }

    <!-- Floating Layer Selector -->
    @if (currentMap.layers && currentMap.layers.length > 1) {
    <div class="floating-layer-selector" [class.inactive-blur]="isChallengeModalOpen">
      <div class="layer-selector-compact">
        <h4>Floors</h4>
        <div class="layer-list-compact">
          @for (layer of currentMap.layers; track layer.id) {
          <button class="layer-button" [class.active]="layer.visible" (click)="selectLayer(layer.id)">
            <span class="layer-name">{{ layer.name }}</span>
            @if (hasSpawnMarkers(layer.id)) {
            <span class="material-icons spawn-indicator" title="Spawn point available">flag</span>
            }
          </button>
          }
        </div>
      </div>
    </div>
    }

    <!-- Coordinate Display removed from map-canvas; moved to fixed container below -->

    <div class="map-zoom-container" [ngStyle]="getMapStyle()" (mousedown)="onMouseDown($event)"
      (mousemove)="onMapMouseMove($event)" (mouseleave)="onMapMouseLeave()" [style.cursor]="getCursor()">

      <!-- Drawing Layer SVG moved here so it covers the whole map-canvas -->
      <app-drawing-layer [drawnLines]="drawnLines" [isDrawing]="isDrawing" [isDrawingMode]="isDrawingMode"
        [isEraserMode]="isEraserMode" [drawingPath]="drawingPath" [selectedDrawColor]="selectedDrawColor">
      </app-drawing-layer>

      <!-- Layers Container with overlays -->
      <div class="layers-container">
        <div class="image-wrapper">
          <!-- Placeholder Image for Under Construction Maps -->
          @if (currentMap.placeholderImage) {
          <div class="under-construction-container">
            <img [src]="currentMap.placeholderImage" [alt]="currentMap.name + ' - Under Construction'" class="placeholder-image"
              draggable="false" />
            <div class="map-under-construction-badge">
              <svg class="tools-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
              </svg>
              <div class="badge-text">
                <span class="badge-title">Under Construction</span>
              </div>
            </div>
          </div>
          } @else {
          <!-- Images -->
          @for (layer of currentMap.layers; track layer.id) {
          @if (layer.visible) {
          <img [src]="layer.imageUrl" [alt]="layer.name" class="layer-image" [style.z-index]="layer.zIndex"
            (click)="onMapClick($event)" draggable="false" />
          }
          }



          <!-- Markers Container -->
          <app-marker-renderer [markers]="visibleMarkers" [currentMapLayers]="currentMap.layers || []"
            [legendItems]="legendItems" [selectedMarker]="selectedMarker"
            (markerClick)="onMarkerClickFromRenderer($event)">
          </app-marker-renderer>
          }
        </div>
      </div>
    </div>
  </div>
  } @else {
  <div class="no-map-selected">
    <div class="no-map-content">
      <h3>No Map Selected</h3>
      <p>Select a map from the panel on the right to start exploring.</p>
    </div>
  </div>
  }

  <!-- Coordinate Display (fixed to viewport) -->
  <app-coordinate-tracker [currentCoords]="currentCoords" [showCoords]="showCoords">
  </app-coordinate-tracker>
</div>