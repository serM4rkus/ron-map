<div class="map-viewer">
  @if (currentMap) {
    <div class="map-canvas" #mapContainer (wheel)="onMouseWheel($event)">
      
      <!-- Loading Spinner -->
      @if (isLoading) {
        <div class="loading-overlay">
          <div class="spinner"></div>
          <p>Loading...</p>
        </div>
      }
      
      <!-- Floating Layer Selector -->
      @if (currentMap.layers && currentMap.layers.length > 1) {
        <div class="floating-layer-selector">
          <div class="layer-selector-compact">
            <h4>Layers</h4>
            <div class="layer-list-compact">
              @for (layer of currentMap.layers; track layer.id) {
                <button 
                  class="layer-button" 
                  [class.active]="layer.visible"
                  (click)="selectLayer(layer.id)"
                >
                  {{ layer.name }}
                </button>
              }
            </div>
          </div>
        </div>
      }

      <!-- Coordinate Display -->
      @if (showCoords && currentCoords) {
        <div class="coordinate-display">
          <span class="coord-label">X:</span>
          <span class="coord-value">{{ currentCoords.x }}%</span>
          <span class="coord-separator">|</span>
          <span class="coord-label">Y:</span>
          <span class="coord-value">{{ currentCoords.y }}%</span>
        </div>
      }
      
      <div class="map-zoom-container" 
           [ngStyle]="getMapStyle()" 
           (mousedown)="onMouseDown($event)"
           (mousemove)="onMapMouseMove($event)"
           (mouseleave)="onMapMouseLeave()"
           [style.cursor]="getCursor()">
        
        <!-- Layers Container with overlays -->
        <div class="layers-container">
          <!-- Images -->
          @for (layer of currentMap.layers; track layer.id) {
            @if (layer.visible) {
              <img 
                [src]="layer.imageUrl" 
                [alt]="layer.name" 
                class="layer-image" 
                [style.z-index]="layer.zIndex"
                (click)="onMapClick($event)"
                draggable="false" 
              />
            }
          }
          
          <!-- Drawing Layer SVG -->
          <svg class="drawing-layer" [style.pointer-events]="isDrawingMode ? 'none' : 'auto'">
            <!-- Completed lines -->
            @for (line of drawnLines; track $index) {
              <path 
                [attr.d]="getDrawingPathString(line.path)" 
                [attr.stroke]="line.color" 
                stroke-width="3" 
                fill="none"
                stroke-linecap="round"
                stroke-linejoin="round" 
              />
            }
            <!-- Current drawing path -->
            @if (isDrawing && drawingPath.length > 0) {
              <path 
                [attr.d]="getDrawingPathString(drawingPath)" 
                [attr.stroke]="selectedDrawColor" 
                stroke-width="3" 
                fill="none"
                stroke-linecap="round"
                stroke-linejoin="round"
                opacity="0.7" 
              />
            }
          </svg>

          <!-- Markers Container -->
          <div class="markers-container">
            @for (marker of getVisibleMarkers(); track marker.id) {
              <div class="marker-wrapper" 
                   [ngClass]="getMarkerClass(marker)" 
                   [ngStyle]="getMarkerStyle(marker)"
                   (click)="selectMarker(marker, $event)">
                <div class="marker-dot" [style.backgroundColor]="marker.color"></div>
                <div class="marker-label">{{ marker.title }}</div>

                @if (selectedMarker?.id === marker.id) {
                  <div class="marker-tooltip">
                    <h4>{{ marker.title }}</h4>
                    <p>{{ marker.description }}</p>
                    <small>Type: {{ marker.type }}</small>
                  </div>
                }
              </div>
            }
          </div>
        </div>
      </div>
    </div>
  } @else {
    <div class="no-map-selected">
      <div class="no-map-content">
        <h3>No Map Selected</h3>
        <p>Select a map from the panel on the right to start exploring.</p>
      </div>
    </div>
  }
</div>
